- hosts: all
  vars:
    applications:
      - git
      - httpie
      - zsh
    necessaryAptRepos:
      - ppa:git-core/ppa
    nvmVersion: 0.37.2

  tasks:
    - name: Add necessary apt repos
      become: yes
      become_method: sudo
      apt_repository:
        repo: "{{ item }}"
        state: present
      loop: "{{ necessaryAptRepos }}"

    - name: Install Applications
      become: yes
      become_method: sudo
      apt:
        pkg: "{{ item }}"
        state: present
      loop: "{{ applications }}"

    - name: Confirm NVM install
      shell: source ~/.nvm/nvm.sh && nvm --version
      register: nvm_installed
      ignore_errors: true
      args:
        executable: /bin/bash

    - name: Get NVM install script
      uri:
        url: https://raw.githubusercontent.com/nvm-sh/nvm/v{{ nvmVersion }}/install.sh
        method: GET
        return_content: yes
      register: nvm_install_script
      when: nvm_installed.stdout != nvmVersion

    - name: Install NVM
      shell: "{{ nvm_install_script.content }}"
      when: nvm_installed.stdout != nvmVersion
      args:
        executable: /bin/bash

    - name: Install Node LTS
      shell: source ~/.nvm/nvm.sh && nvm install --lts
      args:
        executable: /bin/bash

    - name: Check if we have ohmyzsh
      shell: "omz help &> /dev/null"
      register: ohmyzsh_installed
      ignore_errors: true
      args:
        executable: /bin/bash

    - name: Get ohmyzsh install script
      uri:
        url: https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        method: GET
        return_content: yes
      register: ohmyzsh_install_script
      when: ohmyzsh_installed is failed

    - name: Install ohmyzsh
      shell: "{{ ohmyzsh_install_script.content }}"
      when: ohmyzsh_installed is failed
      args:
        executable: /bin/zsh

    - name: Upgrade ohmyzsh
      shell: "omz update"
      when: ohmyzsh_installed is success
      args:
        executable: /bin/zsh
